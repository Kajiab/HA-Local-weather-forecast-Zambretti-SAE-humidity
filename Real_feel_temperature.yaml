template:
  - sensor:
      - name: "Local RealFeel Temperature"
        unique_id: local_real_feel_temp
        unit_of_measurement: "°C"
        state: >-
          {% set T = states('sensor.weatherstation_temperature') | float(none) %}
          {% set R = states('sensor.weatherstation_humidity') | float(none) %}
          
          {% if T is not none and R is not none %}
            {% if T >= 27 %}
              {% set HI = -8.78469475556 + (1.61139411 * T) + (2.33854883889 * R) + (-0.14611605 * T * R) + (-0.012308094 * T**2) + (-0.0164248277778 * R**2) + (0.002211732 * T**2 * R) + (0.00072546 * T * R**2) + (-0.000003582 * T**2 * R**2) %}
              {{ HI | round(1) }}
            {% else %}
              {{ T | round(1) }}
            {% endif %}
          {% else %}
            {{ states('sensor.weatherstation_temperature') | float(0) | round(1) }}
          {% endif %}
        attributes:
          level: >-
            {% set hi_state = states('sensor.local_real_feel_temperature') %}
            {% if is_number(hi_state) %}
              {% set hi = hi_state | float %}
              {% if hi >= 54 %} "Extreme Danger"
              {% elif hi >= 41 %} "Danger"
              {% elif hi >= 32 %} "Extreme Caution"
              {% elif hi >= 27 %} "Caution"
              {% else %} "Comfortable"
              {% endif %}
            {% else %}
              "Waiting for data..."
            {% endif %}
        # 3. จุดสำคัญ: บอกระบบว่าอย่าเพิ่งรันถ้าเซ็นเซอร์หลักยังไม่พร้อม
        availability: >-
          {{ is_number(states('sensor.weatherstation_temperature')) and 
             is_number(states('sensor.weatherstation_humidity')) }}
